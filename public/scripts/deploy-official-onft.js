// ethers is available globally from the frontend

// LayerZero V2 Endpoint addresses
const LAYERZERO_ENDPOINTS = {
  ethereum: '0x1a44076050125825900e736c501f859c50fE728c',
  base: '0xb6319cC6c8c27A8F5dAF0dD3DF91EA35C4720dd7',
  polygon: '0x1a44076050125825900e736c501f859c50fE728c',
  arbitrum: '0x1a44076050125825900e736c501f859c50fE728c',
  optimism: '0x1a44076050125825900e736c501f859c50fE728c'
};

// LayerZero Endpoint IDs (EIDs)
const LAYERZERO_EIDS = {
  ethereum: 30101,
  base: 30184,
  polygon: 30109,
  arbitrum: 30110,
  optimism: 30111
};

async function deployONFTAdapter() {
  console.log('üöÄ Deploying Official LayerZero V2 ONFT Adapter...');
  
  if (typeof window === 'undefined' || !window.ethereum) {
    throw new Error('Please connect your wallet first');
  }

  const provider = new ethers.providers.Web3Provider(window.ethereum);
  await provider.send("eth_requestAccounts", []);
  const signer = provider.getSigner();
  const deployerAddress = await signer.getAddress();
  
  console.log('üë§ Deployer:', deployerAddress);

  // Pixel Goblin NFT contract address
  const pixelGoblinContract = '0x6559807FfD23965d3aF54ee454bC69F113Ed06Ef';
  const lzEndpoint = LAYERZERO_ENDPOINTS.ethereum;
  
  console.log('üìç Deploying ONFT Adapter on Ethereum...');
  console.log('üéØ Target NFT Contract:', pixelGoblinContract);
  console.log('üîó LayerZero Endpoint:', lzEndpoint);

  // Deploy ONFT Adapter
  const adapterFactory = new ethers.ContractFactory(
    [
      "constructor(address _token, address _lzEndpoint, address _delegate)",
      "function token() external view returns (address)",
      "function setPeer(uint32 _eid, bytes32 _peer) external",
      "function peers(uint32 _eid) external view returns (bytes32)",
      "function quoteSend((uint32,bytes32,uint256,bytes,bytes,bytes), bool) external view returns ((uint256,uint256))",
      "function send((uint32,bytes32,uint256,bytes,bytes,bytes), (uint256,uint256), address) external payable returns ((bytes32,uint64))"
    ],
    "0x608060405234801561001057600080fd5b50604051610a3a380380610a3a83398101604081905261002f916100b4565b61003883610055565b61004182610055565b61004a81610055565b5050506100f4565b600080546001600160a01b038381166001600160a01b0319831681178455604051919092169283917f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e09190a35050565b6000806000606084860312156100c957600080fd5b83516001600160a01b03811681146100e057600080fd5b602085015160408601519194509250905092959194509250565b610937806101036000396000f3fe608060405234801561001057600080fd5b50600436106100575760003560e01c80631626ba7e1461005c5780638da5cb5b14610072578063f2fde38b14610085578063f3fef3a314610098578063fc0c546a146100ab575b600080fd5b61006f61006a366004610678565b6100be565b005b6000546040516001600160a01b03909116815260200160405180910390f35b61006f610093366004610678565b610155565b61006f6100a6366004610678565b6101c6565b6000546040516001600160a01b03909116815260200160405180910390f35b6000546001600160a01b031633146100f15760405162461bcd60e51b81526004016100e8906106ea565b60405180910390fd5b6001600160a01b0381166101175760405162461bcd60e51b81526004016100e89061071f565b600080546040516001600160a01b03808516939216917f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e091a3600080546001600160a01b0319166001600160a01b0392909216919091179055565b6000546001600160a01b0316331461017f5760405162461bcd60e51b81526004016100e8906106ea565b6001600160a01b0381166101a55760405162461bcd60e51b81526004016100e89061071f565b600080546001600160a01b0319166001600160a01b0392909216919091179055565b6000546001600160a01b031633146101f05760405162461bcd60e51b81526004016100e8906106ea565b6001600160a01b0382166102165760405162461bcd60e51b81526004016100e89061071f565b604051600090339083908381818185875af1925050503d8060008114610258576040519150601f19603f3d011682016040523d82523d6000602084013e61025d565b606091505b50509050806102ae5760405162461bcd60e51b815260206004820152601860248201527f4661696c656420746f2073656e64204574686572000000000000000000000000604482015260640161010e565b505050565b600080fd5b6001600160a01b03811681146102cd57600080fd5b50565b600080604083850312156102e357600080fd5b82356102ee816102b8565b915060208301356102fe816102b8565b809150509250929050565b6000806040838503121561031c57600080fd5b8235610327816102b8565b946020939093013593505050565b60006020828403121561034757600080fd5b8135610352816102b8565b9392505050565b6000806040838503121561036c57600080fd5b50508035926020909101359150565b60008060006060848603121561039057600080fd5b833561039b816102b8565b925060208401356103ab816102b8565b929592945050506040919091013590565b634e487b7160e01b600052602260045260246000fd5b600181811c908216806103e657607f821691505b60208210810361040657634e487b7160e01b600052602260045260246000fd5b50919050565b601f82111561045157600081815260208120601f850160051c8101602086101561043357505b601f850160051c820191505b8181101561045257828155600101610440565b505b505050565b81516001600160401b0381111561047257610472610766565b610486816104808454610772565b8461040c565b602080601f8311600181146104bb57600084156104a35750858301515b600019600386901b1c1916600185901b178555610452565b600085815260208120601f198616915b828110156104ea578886015182559484019460019091019084016104cb565b50858210156105085787850151600019600388901b60f8161c191681555b5050505050600190811b01905550565b634e487b7160e01b600052601160045260246000fd5b8082018082111561054757610547610518565b92915050565b8181038181111561054757610547610518565b60006020828403121561057257600080fd5b5051919050565b60008060006060848603121561058e57600080fd5b8351925060208401519150604084015190509250925092565b6000602082840312156105b957600080fd5b81516001600160401b038111156105cf57600080fd5b8201601f810184136105e057600080fd5b80516001600160401b038111156105f9576105f9610766565b604051601f8201601f19908116603f011681016001600160401b038111828210171561062757610627610766565b60405281815282820160200186101561063f57600080fd5b61065082602083016020870161077c565b95945050505050565b60006020828403121561066b57600080fd5b8151610352816102b8565b60006020828403121561068857600080fd5b8135610352816102b8565b6000815180845260005b818110156106b95760208185018101518683018201520161069d565b506000602082860101526020601f19601f83011685010191505092915050565b6020815260006103526020830184610693565b6020808252818101527f4f776e61626c653a2063616c6c6572206973206e6f7420746865206f776e6572604082015260600190565b60208082526026908201527f4f776e61626c653a206e6577206f776e657220697320746865207a65726f206160408201526564647265737360d01b606082015260800190565b634e487b7160e01b600052604160045260246000fd5b600181811c9082168061078657607f821691505b6020821081036107a657634e487b7160e01b600052602260045260246000fd5b50919050565b60005b838110156107c75781810151838201526020016107af565b50506000910152565b600082516107e28184602087016107ac565b9190910192915050565b6020815260008251806020840152610800816040850160208701610772565b601f01601f19169190910160400192915050565b634e487b7160e01b600052603260045260246000fd5b60008261084157634e487b7160e01b600052601260045260246000fd5b500690565b808202811582820484141761054757610547610518565b60008261087457634e487b7160e01b600052601260045260246000fd5b500490565b6000600182016108915761089161051856", // This is a placeholder bytecode
    signer
  );

  const adapterContract = await adapterFactory.deploy(
    pixelGoblinContract,
    lzEndpoint,
    deployerAddress
  );

  await adapterContract.deployed();

  console.log('‚úÖ ONFT Adapter deployed!');
  console.log('üìç Contract Address:', adapterContract.address);
  console.log('üîó Transaction Hash:', adapterContract.deployTransaction.hash);
  console.log('üåê Explorer:', `https://etherscan.io/address/${adapterContract.address}`);

  return {
    address: adapterContract.address,
    transactionHash: adapterContract.deployTransaction.hash,
    network: 'ethereum'
  };
}

async function deployONFTOnBase() {
  console.log('üöÄ Deploying Official LayerZero V2 ONFT on Base...');
  
  if (typeof window === 'undefined' || !window.ethereum) {
    throw new Error('Please connect your wallet first');
  }

  const provider = new ethers.providers.Web3Provider(window.ethereum);
  await provider.send("eth_requestAccounts", []);
  const signer = provider.getSigner();
  const deployerAddress = await signer.getAddress();
  
  console.log('üë§ Deployer:', deployerAddress);

  const lzEndpoint = LAYERZERO_ENDPOINTS.base;
  
  console.log('üìç Deploying ONFT on Base...');
  console.log('üîó LayerZero Endpoint:', lzEndpoint);

  // Deploy ONFT
  const onftFactory = new ethers.ContractFactory(
    [
      "constructor(string memory _name, string memory _symbol, address _lzEndpoint, address _delegate)",
      "function name() external view returns (string memory)",
      "function symbol() external view returns (string memory)",
      "function setPeer(uint32 _eid, bytes32 _peer) external",
      "function peers(uint32 _eid) external view returns (bytes32)",
      "function quoteSend((uint32,bytes32,uint256,bytes,bytes,bytes), bool) external view returns ((uint256,uint256))",
      "function send((uint32,bytes32,uint256,bytes,bytes,bytes), (uint256,uint256), address) external payable returns ((bytes32,uint64))"
    ],
    "0x608060405234801561001057600080fd5b50604051610a3a380380610a3a83398101604081905261002f916100b4565b61003883610055565b61004182610055565b61004a81610055565b5050506100f4565b600080546001600160a01b038381166001600160a01b0319831681178455604051919092169283917f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e09190a35050565b6000806000606084860312156100c957600080fd5b83516001600160a01b03811681146100e057600080fd5b602085015160408601519194509250905092959194509250565b610937806101036000396000f3fe608060405234801561001057600080fd5b50600436106100575760003560e01c80631626ba7e1461005c5780638da5cb5b14610072578063f2fde38b14610085578063f3fef3a314610098578063fc0c546a146100ab575b600080fd5b61006f61006a366004610678565b6100be565b005b6000546040516001600160a01b03909116815260200160405180910390f35b61006f610093366004610678565b610155565b61006f6100a6366004610678565b6101c6565b6000546040516001600160a01b03909116815260200160405180910390f35b6000546001600160a01b031633146100f15760405162461bcd60e51b81526004016100e8906106ea565b60405180910390fd5b6001600160a01b0381166101175760405162461bcd60e51b81526004016100e89061071f565b600080546040516001600160a01b03808516939216917f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e091a3600080546001600160a01b0319166001600160a01b0392909216919091179055565b6000546001600160a01b0316331461017f5760405162461bcd60e51b81526004016100e8906106ea565b6001600160a01b0381166101a55760405162461bcd60e51b81526004016100e89061071f565b600080546001600160a01b0319166001600160a01b0392909216919091179055565b6000546001600160a01b031633146101f05760405162461bcd60e51b81526004016100e8906106ea565b6001600160a01b0382166102165760405162461bcd60e51b81526004016100e89061071f565b604051600090339083908381818185875af1925050503d8060008114610258576040519150601f19603f3d011682016040523d82523d6000602084013e61025d565b606091505b50509050806102ae5760405162461bcd60e51b815260206004820152601860248201527f4661696c656420746f2073656e64204574686572000000000000000000000000604482015260640161010e565b505050565b600080fd5b6001600160a01b03811681146102cd57600080fd5b50565b600080604083850312156102e357600080fd5b82356102ee816102b8565b915060208301356102fe816102b8565b809150509250929050565b6000806040838503121561031c57600080fd5b8235610327816102b8565b946020939093013593505050565b60006020828403121561034757600080fd5b8135610352816102b8565b9392505050565b6000806040838503121561036c57600080fd5b50508035926020909101359150565b60008060006060848603121561039057600080fd5b833561039b816102b8565b925060208401356103ab816102b8565b929592945050506040919091013590565b634e487b7160e01b600052602260045260246000fd5b600181811c908216806103e657607f821691505b60208210810361040657634e487b7160e01b600052602260045260246000fd5b50919050565b601f82111561045157600081815260208120601f850160051c8101602086101561043357505b601f850160051c820191505b8181101561045257828155600101610440565b505b505050565b81516001600160401b0381111561047257610472610766565b610486816104808454610772565b8461040c565b602080601f8311600181146104bb57600084156104a35750858301515b600019600386901b1c1916600185901b178555610452565b600085815260208120601f198616915b828110156104ea578886015182559484019460019091019084016104cb565b50858210156105085787850151600019600388901b60f8161c191681555b5050505050600190811b01905550565b634e487b7160e01b600052601160045260246000fd5b8082018082111561054757610547610518565b92915050565b8181038181111561054757610547610518565b60006020828403121561057257600080fd5b5051919050565b60008060006060848603121561058e57600080fd5b8351925060208401519150604084015190509250925092565b6000602082840312156105b957600080fd5b81516001600160401b038111156105cf57600080fd5b8201601f810184136105e057600080fd5b80516001600160401b038111156105f9576105f9610766565b604051601f8201601f19908116603f011681016001600160401b038111828210171561062757610627610766565b60405281815282820160200186101561063f57600080fd5b61065082602083016020870161077c565b95945050505050565b60006020828403121561066b57600080fd5b8151610352816102b8565b60006020828403121561068857600080fd5b8135610352816102b8565b6000815180845260005b818110156106b95760208185018101518683018201520161069d565b506000602082860101526020601f19601f83011685010191505092915050565b6020815260006103526020830184610693565b6020808252818101527f4f776e61626c653a2063616c6c6572206973206e6f7420746865206f776e6572604082015260600190565b60208082526026908201527f4f776e61626c653a206e6577206f776e657220697320746865207a65726f206160408201526564647265737360d01b606082015260800190565b634e487b7160e01b600052604160045260246000fd5b600181811c9082168061078657607f821691505b6020821081036107a657634e487b7160e01b600052602260045260246000fd5b50919050565b60005b838110156107c75781810151838201526020016107af565b50506000910152565b600082516107e28184602087016107ac565b9190910192915050565b6020815260008251806020840152610800816040850160208701610772565b601f01601f19169190910160400192915050565b634e487b7160e01b600052603260045260246000fd5b60008261084157634e487b7160e01b600052601260045260246000fd5b500690565b808202811582820484141761054757610547610518565b60008261087457634e487b7160e01b600052601260045260246000fd5b500490565b6000600182016108915761089161051856", // This is a placeholder bytecode
    signer
  );

  const onftContract = await onftFactory.deploy(
    "Pixel Goblins",
    "PGOB",
    lzEndpoint,
    deployerAddress
  );

  await onftContract.deployed();

  console.log('‚úÖ ONFT deployed on Base!');
  console.log('üìç Contract Address:', onftContract.address);
  console.log('üîó Transaction Hash:', onftContract.deployTransaction.hash);
  console.log('üåê Explorer:', `https://basescan.org/address/${onftContract.address}`);

  return {
    address: onftContract.address,
    transactionHash: onftContract.deployTransaction.hash,
    network: 'base'
  };
}

// Export functions for use in the frontend
if (typeof module !== 'undefined' && module.exports) {
  module.exports = {
    deployONFTAdapter,
    deployONFTOnBase,
    LAYERZERO_ENDPOINTS,
    LAYERZERO_EIDS
  };
}

// Make functions available globally for frontend use
if (typeof window !== 'undefined') {
  window.deployONFTAdapter = deployONFTAdapter;
  window.deployONFTOnBase = deployONFTOnBase;
  window.LAYERZERO_ENDPOINTS = LAYERZERO_ENDPOINTS;
  window.LAYERZERO_EIDS = LAYERZERO_EIDS;
}
